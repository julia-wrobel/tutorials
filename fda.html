<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Functional regression in R</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/lumen.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-6.5.2/css/all.min.css" rel="stylesheet" />
<link href="site_libs/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>






<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Home</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://juliawrobel.com/research.html">Research</a>
</li>
<li>
  <a href="http://juliawrobel.com/papers.html">Papers</a>
</li>
<li>
  <a href="http://juliawrobel.com/software.html">Software</a>
</li>
<li>
  <a href="tutorials.html">Tutorials</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="mailto:&lt;jw3134@cumc.columbia.edu&gt;">
    <span class="fa fa-envelope fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="http://juliawrobel.com/Downloads/wrobel_cv.pdf">
    <span class="ai ai-cv ai-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://scholar.google.com/citations?user=QI8GrFUAAAAJ&amp;hl=en&amp;oi=ao">
    <span class="ai ai-google-scholar-square ai-lg"></span>
     
  </a>
</li>
<li>
  <a href="http://github.com/julia-wrobel/">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Functional regression in R</h1>

</div>


<p><link rel="stylesheet" href="academicons.css"/>
<link rel="stylesheet" href="styles.css" type="text/css"></p>
<p>This tutorial provides an introduction to key functional regression
models. It is a work in progress and will likely be updated over time.
Libraries used in this tutorial are loaded below.</p>
<pre class="r"><code>library(tidyverse)
## ── Attaching core tidyverse packages
## ✔ dplyr     1.1.4     ✔ readr     2.1.5
## ✔ forcats   1.0.0     ✔ stringr   1.5.1
## ✔ ggplot2   3.5.1     ✔ tibble    3.2.1
## ✔ lubridate 1.9.4     ✔ tidyr     1.3.1
## ✔ purrr     1.0.4     
## ── Conflicts ───────────────────────
## ✖ dplyr::filter() masks stats::filter()
## ✖ dplyr::lag()    masks stats::lag()
## ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors
library(refund)
library(mgcv)
## Loading required package: nlme
## 
## Attaching package: &#39;nlme&#39;
## 
## The following object is masked from &#39;package:dplyr&#39;:
## 
##     collapse
## 
## This is mgcv 1.9-1. For overview type &#39;help(&quot;mgcv-package&quot;)&#39;.
library(tictoc)
library(vbvs.concurrent) # devtools::install_github(&quot;jeff-goldsmith/vbvs.concurrent&quot;)
library(viridis)
## Loading required package: viridisLite
library(patchwork)</code></pre>
<p>Note that we will use the <code>refund</code> package,
<code>vbvs.concurrent</code>, and <code>mgcv</code> to do functional
data analysis.</p>
<div id="pupillometer-data" class="section level1">
<h1>Pupillometer data</h1>
<p>I will be using examples using curves of pupil response to a light
stimulus. Some subjects smoke cannabis 60 minutes before the light
stimulus and others did not. The goal is to see whether the pupil
response to light differs for those who used cannabis. You can download
the data <a href="Downloads/pupil.Rdata">here</a>.</p>
<pre class="r"><code>load(here::here(&quot;Downloads&quot;, &quot;pupil.Rdata&quot;))

head(pupil)
## # A tibble: 6 × 10
##   id      use_group              use   age gender   bmi alcohol seconds
##   &lt;chr&gt;   &lt;chr&gt;                &lt;dbl&gt; &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
## 1 003-001 Daily - Concentrates     1    27 Female  22.9       4   0.602
## 2 003-001 Daily - Concentrates     1    27 Female  22.9       4   0.635
## 3 003-001 Daily - Concentrates     1    27 Female  22.9       4   0.668
## 4 003-001 Daily - Concentrates     1    27 Female  22.9       4   0.702
## 5 003-001 Daily - Concentrates     1    27 Female  22.9       4   0.735
## 6 003-001 Daily - Concentrates     1    27 Female  22.9       4   0.769
## # ℹ 2 more variables: percent_change_baseline &lt;dbl&gt;, percent_change &lt;dbl&gt;</code></pre>
<p>The functional data is percent change in pupil diameter over the
course of 5 seconds immediately after the pupil is exposed to a flash of
light. This is referred to as the <strong>pupil light response
curve</strong>.</p>
<p>Variables included in this dataset are:</p>
<ul>
<li><code>id</code>: subject id</li>
<li><code>use</code>: whether a subject used cannabis,
<code>1=use</code> and <code>0=no use</code></li>
<li><code>age</code>, in years</li>
<li><code>alcohol</code>: average weekly number of alcoholic
beverages</li>
<li><code>seconds</code>: the functional domain</li>
<li><code>percent_change</code>: the pupil light response curve
collected 40 minutes <strong>after</strong> smoking cannabis for those
with <code>use = 1</code> and after an equivalent no-smoking rest time
for those with <code>use = 0</code></li>
<li><code>percent_change_baseline</code>: the pupil light response curve
values at baseline, before any participants have consumed cannabis</li>
</ul>
<p>Curves are shown below:</p>
<pre class="r"><code>
baseline = pupil %&gt;%
  ggplot(aes(seconds, percent_change_baseline)) +
  geom_line(aes(group = id), alpha = 0.2) +
  geom_smooth(aes(color = factor(use), linetype = factor(use)), se = FALSE) +
  #facet_wrap(~use_group) +
  theme_minimal() +
  ylim(-60, 20) +
  theme(legend.position = &quot;bottom&quot;) 

post = pupil %&gt;%
  ggplot(aes(seconds, percent_change)) +
  geom_line(aes(group = id), alpha = 0.2) +
  geom_smooth(aes(color = factor(use), linetype = factor(use)), se = FALSE) +
  #facet_wrap(~use_group) +
  theme_minimal() +
  ylim(-60, 20) +
  theme(legend.position = &quot;bottom&quot;) 
  
baseline + post
## `geom_smooth()` using method =
## &#39;gam&#39; and formula = &#39;y ~ s(x, bs =
## &quot;cs&quot;)&#39;
## Warning: Removed 546 rows containing
## non-finite outside the scale range
## (`stat_smooth()`).
## Warning: Removed 528 rows containing missing
## values or values outside the scale
## range (`geom_line()`).
## `geom_smooth()` using method =
## &#39;gam&#39; and formula = &#39;y ~ s(x, bs =
## &quot;cs&quot;)&#39;
## Warning: Removed 289 rows containing
## non-finite outside the scale range
## (`stat_smooth()`).
## Warning: Removed 264 rows containing missing
## values or values outside the scale
## range (`geom_line()`).</code></pre>
<p><img src="fda_files/figure-html/unnamed-chunk-4-1.png" width="90%" /></p>
</div>
<div id="sofr" class="section level1">
<h1>SoFR</h1>
<p>For scalar-on-function regression with a Gaussian outcome the model
we are interested in is</p>
<p><span class="math display">\[Y_i = \beta_0 + \sum_j \beta_jX_{ij} +
\sum_k\int_t \mathcal{B}_k(t)Z_{ik}(t)dt + \epsilon_i,\]</span>
where:</p>
<ul>
<li><span class="math inline">\(Y_i\)</span> is a scalar outcome</li>
<li>Each <span class="math inline">\(X_{ij}\)</span> is a scalar
covariate</li>
<li>Each <span class="math inline">\(\beta_j\)</span> is a regression
coefficient for a scalar covariate</li>
<li>Each <span class="math inline">\(Z_{ik}(t)\)</span> is a functional
covariate</li>
<li>Each <span class="math inline">\(\mathcal{B}_k(t)\)</span> is a
<em>coefficient function</em>, a regression coefficient for a functional
covariate</li>
<li><span class="math inline">\(\epsilon_i\)</span> are normally
distributed iid errors</li>
</ul>
<p>The GLM version of this model (for non-Gaussian outcomes, usually
binary) is:</p>
<p><span class="math display">\[g(E[Y_i|X_i, Z_i]) = \beta_0 + \sum_j
\beta_jX_{ij} + \sum_k\int_t \mathcal{B}_k(t)Z_{ik}(t)dt,\]</span> where
<span class="math inline">\(g(\cdot)\)</span> is a known link function
(think logit in the case of logistic regression, for example.)</p>
<div id="important-practical-considerations" class="section level2">
<h2>Important practical considerations</h2>
<ul>
<li>For SoFR, can’t have missing functional observations so need to
impute or remove
<ul>
<li>Default is to use complete.cases (check your sample size in the
results!)</li>
</ul></li>
<li>For <code>pfr()</code>, binomial responses should be specified as a
numeric vector rather than as a matrix or a factor.</li>
</ul>
</div>
<div id="refundpfr" class="section level2">
<h2>refund::pfr()</h2>
<p>First I’ll fit a model with a continuous scalar outcome (age) and
functional predictor (percent change in pupil size) using the
<code>pfr()</code> function from the <code>refund</code> package.
<code>pfr</code> stands for “penalized functional regression” and was
originally associated with this paper (ADD REFERENCE).</p>
<p>The data need to be set up a specific way for modeling so we will
process the data first.</p>
<pre class="r"><code>sofr_df = pupil %&gt;%
  select(-percent_change_baseline) %&gt;%
  pivot_wider(names_from = seconds, values_from = percent_change, 
                names_prefix = &quot;t_&quot;) %&gt;%
  as.data.frame()

pupil_mat = sofr_df %&gt;% select(starts_with(&quot;t_&quot;)) %&gt;% as.matrix()

# reorganize data for use with refund::pfr() function
sofr_df$percent_change = pupil_mat</code></pre>
<pre class="r"><code>pfr_age = pfr(age ~ lf(percent_change, k = 30, bs = &quot;cr&quot;),
              data = sofr_df)</code></pre>
<pre class="r"><code>summary(pfr_age)
## 
## Family: gaussian 
## Link function: identity 
## 
## Formula:
## age ~ s(x = percent_change.tmat, by = L.percent_change, k = 30, 
##     bs = &quot;cr&quot;)
## 
## Parametric coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)   33.275      2.742   12.13   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Approximate significance of smooth terms:
##                                           edf Ref.df     F p-value
## s(percent_change.tmat):L.percent_change 2.001  2.002 0.353   0.703
## 
## R-sq.(adj) =  -0.0105   Deviance explained = 0.577%
## -REML = 397.52  Scale est. = 35.808    n = 125

plot(pfr_age)</code></pre>
<p><img src="fda_files/figure-html/unnamed-chunk-7-1.png" width="90%" /></p>
<pre class="r"><code>pfr_use = pfr(use ~ lf(percent_change, k = 30, bs = &quot;cr&quot;) + age + alcohol,
              family = binomial,
              data = sofr_df)</code></pre>
<p>Below I show model summary and default plotting function.</p>
<pre class="r"><code>summary(pfr_use)
## 
## Family: binomial 
## Link function: logit 
## 
## Formula:
## use ~ s(x = percent_change.tmat, by = L.percent_change, k = 30, 
##     bs = &quot;cr&quot;) + age + alcohol
## 
## Parametric coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  8.40930    2.37732   3.537 0.000404 ***
## age         -0.04372    0.03687  -1.186 0.235691    
## alcohol      0.08186    0.07870   1.040 0.298251    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Approximate significance of smooth terms:
##                                           edf Ref.df Chi.sq p-value   
## s(percent_change.tmat):L.percent_change 2.843   3.17  13.93 0.00363 **
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## R-sq.(adj) =  0.169   Deviance explained = 18.1%
## -REML = 61.511  Scale est. = 1         n = 125
plot(pfr_use)</code></pre>
<p><img src="fda_files/figure-html/unnamed-chunk-9-1.png" width="90%" /></p>
</div>
<div id="mgcvgam" class="section level2">
<h2>mgcv::gam()</h2>
<p>First we need to process the data a little bit differently- some of
this is done under the hood in <code>pfr()</code></p>
<pre class="r"><code>ncols = ncol(pupil_mat)

# vector, matrix containing functional domain of observed data (assumes everyone is on the same grid)
sind = seq(0, 1, len = ncols)
smat = matrix(sind, nrow(sofr_df), ncols, byrow = TRUE)
  
# construct quadrature weights for numeric integration  
sofr_df$smat = I(smat)
sofr_df$lmat = I(matrix(1/ncols, nrow(sofr_df), ncols))
sofr_df$zlmat = I(sofr_df$lmat * sofr_df$percent_change)
</code></pre>
<pre class="r"><code>gam_use = gam(use ~ s(smat, by=zlmat, bs = &quot;cr&quot;, k = 30) + age + alcohol, 
                   data= sofr_df,
                   method = &quot;REML&quot;, family = binomial)</code></pre>
<pre class="r"><code>summary(gam_use)
## 
## Family: binomial 
## Link function: logit 
## 
## Formula:
## use ~ s(smat, by = zlmat, bs = &quot;cr&quot;, k = 30) + age + alcohol
## 
## Parametric coefficients:
##             Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  8.40040    2.37674   3.534 0.000409 ***
## age         -0.04375    0.03687  -1.187 0.235315    
## alcohol      0.08181    0.07870   1.040 0.298552    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Approximate significance of smooth terms:
##                 edf Ref.df Chi.sq p-value   
## s(smat):zlmat 2.844  3.175   13.9 0.00369 **
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## R-sq.(adj) =  0.169   Deviance explained =   18%
## -REML = 61.547  Scale est. = 1         n = 125
plot(gam_use)</code></pre>
<p><img src="fda_files/figure-html/unnamed-chunk-14-1.png" width="90%" /></p>
<div id="plotting-in-mgcv" class="section level3">
<h3>Plotting in mgcv</h3>
<p>Here we show how to obtain pointwise confidence intervals for
coefficient functions</p>
<pre class="r"><code>
# put required data inputs into a dataframe
# need to have same names as covariates in model
s_pred = seq(0,1, length.out = 100)
df_pred = data.frame(smat = s_pred, zlmat = 1, alcohol = 0, age = 0)

# call predict.gam
coef_est = predict(gam_use, newdata = df_pred, type = &quot;terms&quot;, se.fit = TRUE)

# extract point estimate and pointwise standard errors
beta_hat = coef_est$fit[,3]
se_beta_hat = coef_est$se.fit[,3]

# construct lower and upper 95% confidence bounds
lower = beta_hat - 1.96 * se_beta_hat
upper = beta_hat + 1.96 * se_beta_hat</code></pre>
<p>Plot the results- I am plotting <span
class="math inline">\(\beta(t)\)</span> here but could also plot <span
class="math inline">\(e^{\beta(t)}\)</span> to get the odds ratio.</p>
<pre class="r"><code>tibble(time = s_pred, beta_hat = beta_hat, lower = lower, upper = upper) %&gt;%
  ggplot(aes(time, beta_hat)) + 
  geom_line() +
  geom_line(aes(y = lower), linetype = 2, color = &quot;blue&quot;) +
  geom_line(aes(y = upper), linetype = 2, color = &quot;blue&quot;) +
  geom_hline(yintercept = 0, linetype = 3, color = &quot;red&quot;) +
  theme_minimal()</code></pre>
<p><img src="fda_files/figure-html/unnamed-chunk-16-1.png" width="90%" /></p>
</div>
</div>
</div>
<div id="fosr" class="section level1">
<h1>FoSR</h1>
<p>The function-on-scalar regression model is</p>
<p><span class="math display">\[Y_i(t) = \beta_0(t) + \sum_j
\beta_j(t)X_{ij} + b_i(t) + \epsilon_i(t),\]</span></p>
<p>where:</p>
<ul>
<li><span class="math inline">\(Y_i(t)\)</span> is a functional
outcome</li>
<li>Each <span class="math inline">\(X_{ij}\)</span> is a scalar
covariate</li>
<li>Each <span class="math inline">\(\beta_j(t)\)</span> is a
coefficient function</li>
<li><span class="math inline">\(b_i(t)\)</span> is a subject-specific
functional random effect. This captures correlation within subjects over
time that is not captured by the mean. This term is not always included
in FoSR models, but it’s generally a good idea because it gives better
inference</li>
<li><span class="math inline">\(\epsilon_i(t)\)</span> are normally
distributed iid errors</li>
</ul>
<div id="important-practical-considerations-1" class="section level2">
<h2>Important practical considerations</h2>
<ul>
<li>Need to dummy code categorical variables (1 vs. 0 for binary, for
example)</li>
<li>Subject id variable should be a factor</li>
<li>Pointwise confidence intervals are technically subject to multiple
comparisons issues</li>
</ul>
</div>
<div id="modeling" class="section level2">
<h2>Modeling</h2>
<p>For FoSR I like to use <code>mgcv::gam()</code> directly. This
modeling process happens in 3 steps:</p>
<ol style="list-style-type: decimal">
<li>Fit the mean model <span class="math inline">\(Y_i(t) = \beta_0(t) +
\sum_j \beta_j(t)X_{ij} + \epsilon_i(t)\)</span>, assuming iid errors
across individuals and the domain.</li>
<li>Obtain residuals from the model in step (1) and decompose these into
principle directions of variation (eigenfunctions) using FPCA.</li>
<li>Refit the model using top eigenfunctions from step (2) as random
effects. This step allows us to estimate <span
class="math inline">\(b_i(t)\)</span> and obtain more valid inference
for our coefficient function.</li>
</ol>
<p>These steps are implemented below:</p>
<pre class="r"><code>##########################################################################################
## step 1
mean_mod = mgcv::gam(percent_change ~ s(seconds, k=30, bs=&quot;cr&quot;) + 
                          s(seconds, by=use, k=30, bs = &quot;cr&quot;), 
                  data = pupil, method = &quot;REML&quot;)

########################################################################################## 
## step 2
## Create a matrix of residuals

resid_df = pupil %&gt;%
  filter(!is.na(percent_change)) %&gt;%
  select(id, seconds) %&gt;%
  mutate(resid = mean_mod$residuals) %&gt;%
  pivot_wider(names_from = seconds, values_from = resid, names_prefix = &quot;resid.&quot;)
  
resid_mat = as.matrix(resid_df[,-1])
rownames(resid_mat) = resid_df$id

fpca_results = fpca.face(resid_mat, argvals = unique(pupil$seconds), knots = 15)
eigenfunctions &lt;- as.data.frame(fpca_results$efunctions)
colnames(eigenfunctions) &lt;- paste0(&quot;Phi&quot;, seq(1, fpca_results$npc))
eigenfunctions$seconds &lt;- unique(pupil$seconds)
pupil = pupil %&gt;% left_join(., eigenfunctions, by = &quot;seconds&quot;) %&gt;%
  as_tibble() %&gt;%
  arrange(id, seconds) %&gt;%
  mutate(id = factor(id))

##########################################################################################
# Step 3

fosr_mod &lt;- mgcv::bam(percent_change ~ 
                            s(seconds, k=30, bs=&quot;cr&quot;) + 
                            s(seconds, by=use, k=30, bs = &quot;cr&quot;) + 
                            s(id, by = Phi1, bs=&quot;re&quot;) + 
                            s(id, by = Phi2, bs=&quot;re&quot;)+
                            s(id, by = Phi3, bs=&quot;re&quot;) + 
                            s(id, by = Phi4, bs=&quot;re&quot;), 
                          method = &quot;fREML&quot;, data = pupil, discrete = TRUE)
summary(fosr_mod)
## 
## Family: gaussian 
## Link function: identity 
## 
## Formula:
## percent_change ~ s(seconds, k = 30, bs = &quot;cr&quot;) + s(seconds, by = use, 
##     k = 30, bs = &quot;cr&quot;) + s(id, by = Phi1, bs = &quot;re&quot;) + s(id, 
##     by = Phi2, bs = &quot;re&quot;) + s(id, by = Phi3, bs = &quot;re&quot;) + s(id, 
##     by = Phi4, bs = &quot;re&quot;)
## 
## Parametric coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept) -25.1007     0.8544  -29.38   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Approximate significance of smooth terms:
##                   edf Ref.df        F p-value    
## s(seconds)      28.57  28.90  272.106  &lt;2e-16 ***
## s(seconds):use  11.54  14.17    9.762  &lt;2e-16 ***
## s(id):Phi1     123.16 125.00 4321.616  &lt;2e-16 ***
## s(id):Phi2     123.57 125.00  923.221  &lt;2e-16 ***
## s(id):Phi3     123.52 125.00  467.269  &lt;2e-16 ***
## s(id):Phi4     122.73 125.00  113.579  &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## R-sq.(adj) =  0.995   Deviance explained = 99.5%
## fREML =  24304  Scale est. = 0.90382   n = 16500</code></pre>
</div>
<div id="plotting" class="section level2">
<h2>Plotting</h2>
<p>Here we will plot results much the same way we did when plotting
results for SoFR</p>
<pre class="r"><code># put required data inputs into a dataframe
# need to have same names as covariates in model
s_pred = seq(0,1, length.out = 100)
df_pred = pupil %&gt;%
  filter(id == first(id))

# call predict.gam
coef_est = predict(fosr_mod, newdata = df_pred, type = &quot;terms&quot;, se.fit = TRUE)



tibble(beta1 =  coef_est$fit[, 2],
       seconds = df_pred$seconds,
       se_beta1 = coef_est$se.fit[,2],
       lower = beta1 - 1.96 * se_beta1,
       upper = beta1 + 1.96 * se_beta1) %&gt;%
    ggplot(aes(seconds, beta1)) + 
  geom_line() +
  geom_line(aes(y = lower), linetype = 2, color = &quot;blue&quot;) +
  geom_line(aes(y = upper), linetype = 2, color = &quot;blue&quot;) +
  geom_hline(yintercept = 0, linetype = 3, color = &quot;red&quot;) +
  theme_minimal()</code></pre>
<p><img src="fda_files/figure-html/unnamed-chunk-18-1.png" width="90%" /></p>
</div>
</div>
<div id="fofr" class="section level1">
<h1>FoFR</h1>
<p>Function-on-function regression is a class of models where the
outcome is a function and the covariate(s) is/are also functions. There
are different formulations of this model and which one you pick really
depends on what your data looks like and what questions you’re trying to
answer.</p>
<p>The main models to consider are summarized below.</p>
<div id="important-practical-considerations-2" class="section level2">
<h2>Important practical considerations</h2>
<p>FLCM:</p>
<ul>
<li>Spline estimates aren’t penalized (I believe)</li>
<li>To get confidence intervals I would recommend the bootstrap</li>
<li>I’m not sure that you can include scalar predictors</li>
</ul>
<p>FoFR and Functional historical model implemented in
<code>refund::pffr()</code></p>
<ul>
<li>Can’t have missing functional observations so need to impute or
remove
<ul>
<li>Code will break if you have missing data</li>
</ul></li>
<li>There is a lot more you can do with <code>pffr</code> than I know
how to do without digging into it.</li>
</ul>
</div>
<div id="functional-linear-concurrent-model-flcm"
class="section level2">
<h2>Functional linear concurrent model (FLCM)</h2>
<p>A functional linear concurrent model describes the relationship
between a functional response and a functional predictor, where the
effect of the predictor at each time point is modeled by a time-varying
coefficient function, allowing the association to evolve dynamically
over time. A functional linear concurrent model can be thought of as
performing separate linear regressions at each time point <span
class="math inline">\(t\)</span>, but with the added constraint that the
regression coefficients vary smoothly over <span
class="math inline">\(t\)</span>, ensuring temporal coherence in the
estimated relationship between the functional predictor and
response.</p>
<p>This model is given by:</p>
<p><span class="math display">\[Y_i(t) =   \beta_0(t) + \sum_{j}
\beta_j(t)X_{ij}(t)  + b_i(t) +  \epsilon_i(t)\]</span></p>
<div id="code" class="section level3">
<h3>Code</h3>
<pre class="r"><code>    flcm = vb_concurrent(percent_change ~ percent_change_baseline | seconds, 
                              id.var = &quot;id&quot;,
                            data = pupil, 
                              Kt = 20, # number of spline basis functions 
                              Kp = 10 # number of FPCs to estimate
                              )
## Standardizing Variables 
## ..
## Constructing Xstar; doing data organization 
## Beginning Algorithm 
## ..........
## Warning: `arrange_()` was deprecated in
## dplyr 0.7.0.
## ℹ Please use `arrange()` instead.
## ℹ See vignette(&#39;programming&#39;) for
##   more help
## ℹ The deprecated feature was likely
##   used in the vbvs.concurrent
##   package.
##   Please report the issue to the
##   authors.
## This warning is displayed once
## every 8 hours.
## Call
## `lifecycle::last_lifecycle_warnings()`
## to see where this warning was
## generated.
## Warning: `rename_()` was deprecated in dplyr
## 0.7.0.
## ℹ Please use `rename()` instead.
## ℹ The deprecated feature was likely
##   used in the vbvs.concurrent
##   package.
##   Please report the issue to the
##   authors.
## This warning is displayed once
## every 8 hours.
## Call
## `lifecycle::last_lifecycle_warnings()`
## to see where this warning was
## generated.</code></pre>
<p>Plotting the coefficient function.</p>
<pre class="r"><code>flcm$beta.pm %&gt;%
  ggplot(aes(seconds, percent_change_baseline)) +
  geom_line()</code></pre>
<p><img src="fda_files/figure-html/unnamed-chunk-20-1.png" width="90%" /></p>
</div>
</div>
<div id="historical-functional-model" class="section level2">
<h2>Historical functional model</h2>
<p>A historical functional model extends the functional linear
concurrent model by allowing the response at time <span
class="math inline">\(t\)</span> to depend not only on the predictor at
<span class="math inline">\(t\)</span> but also on its past values.</p>
<ul>
<li>Useful for when function and covariate are observed on the same
domain, and you don’t want the covariate measurements from the future to
predict the response in the present.</li>
</ul>
<p><span class="math display">\[Y_i(t) =   \beta_0(t) + \sum_{j}\int_{s
= 0}^t \beta_j(t, s)X_{ij}(s)ds  + b_i(t) +  \epsilon_i(t)\]</span></p>
<div id="code-1" class="section level3">
<h3>Code</h3>
<p>For this and for the FoFR model, we will use the <code>pffr</code>
function from the refund package. First we have to rearrange the data to
work with <code>pffr</code>.</p>
<pre class="r"><code>pupil_noMissing = pupil %&gt;%
  group_by(id) %&gt;%
  mutate(missing = sum(is.na(percent_change_baseline))+ sum(is.na(percent_change))) %&gt;%
  ungroup() %&gt;%
  filter(missing == 0)



nsubj = length(unique(pupil_noMissing$id)) # number of subjects
ntime = length(unique(pupil_noMissing$seconds)) # number of time points, assuming subjects are measured on the same grid
    
y_fofr = matrix(pupil_noMissing$percent_change, nrow = nsubj, ncol = ntime, byrow = TRUE)
x_fofr = matrix(pupil_noMissing$percent_change_baseline, nrow = nsubj, ncol = ntime, byrow = TRUE)

fofr_df = pupil_noMissing %&gt;%
  select(id, use, age) %&gt;% distinct() %&gt;% as.data.frame()


fofr_df$y = y_fofr
fofr_df$x = x_fofr

t = s = unique(pupil$seconds)

# need to either impute or remove missing values in the x
fofr_df = fofr_df[complete.cases(fofr_df),]</code></pre>
<p>Now we can do the modeling- I’m only going to model the use group to
speed this up, but also because I believe the results are more
interesting.</p>
<pre class="r"><code>
fhist_mod = pffr(y ~ s(id, bs = &quot;re&quot;) + ff(x, xind = s, limits = &quot;s&lt;t&quot;,
                                               splinepars = list(bs = &quot;ps&quot;, 
                                                              k= c(5, 5))), 
                     yind = t, filter(fofr_df, use == 1))
## &lt;limits&gt;-argument detected. Changing to Riemann sums for numerical integration.
## Warning in ff(x, xind = s, limits = &quot;s&lt;t&quot;, splinepars = list(bs = &quot;ps&quot;, : Very
## low effective rank of &lt;x&gt; detected. 3 largest eigenvalues of its covariance
## alone account for &gt;99.5% of variability. &lt;ffpc&gt; might be a better choice here.
## Warning in ff(x, xind = s, limits = &quot;s&lt;t&quot;, splinepars = list(bs = &quot;ps&quot;, : &lt;k&gt;
## larger than effective rank of &lt;x&gt;. Model identifiable only through penalty.</code></pre>
<p>where</p>
<ul>
<li><code>s(seconds, bs = "re")</code>: subject specific random
intercept <span class="math inline">\(b_i(t)\)</span></li>
<li><code>k= c(15, 15)</code>: defines number of basis functions for the
surface (default is 5, which is probably too few but I’m using that
right now because it is faster)</li>
</ul>
<pre class="r"><code>summary(fhist_mod)
## 
## Family: gaussian 
## Link function: identity 
## 
## Formula:
## y ~ s(id, bs = &quot;re&quot;) + ff(x, xind = s, limits = &quot;s&lt;t&quot;, splinepars = list(bs = &quot;ps&quot;, 
##     k = c(5, 5)))
## 
## Constant coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -29.934      1.868  -16.03   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Smooth terms &amp; functional coefficients:
##                 edf Ref.df     F p-value    
## Intercept(t)  18.51  19.00 327.4  &lt;2e-16 ***
## s(id)        446.16 457.00 444.8  &lt;2e-16 ***
## ff(x,s)       21.06  21.61 111.1  &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## R-sq.(adj) =  0.992   Deviance explained = 99.2%
## -REML score =  20494  Scale est. = 1.3308    n = 12144 (92 x 132)</code></pre>
<p>Finally, do the plotting. Now we have estimated a coefficient surface
instead of a coefficient function.</p>
<pre class="r"><code># extract surface for plotting
fhist_surf = coef(fhist_mod, n1 = 100, n2 = 100)$smterms$&quot;ff(x,s)&quot;$coef %&gt;%
  select(s = x.smat, t = x.tmat, value = value) %&gt;% 
  as_tibble() %&gt;%
  mutate(value = ifelse(s&gt;t, NA, value))
## using seWithMean for  s(t.vec) .

fhist_surf %&gt;%
  ggplot(aes(s, t)) + 
  geom_tile(aes(fill = value, col = value)) + 
  scale_fill_viridis_c() +
  scale_colour_viridis_c() +
  theme(legend.position = &quot;bottom&quot;)</code></pre>
<p><img src="fda_files/figure-html/unnamed-chunk-24-1.png" width="90%" /></p>
</div>
</div>
<div id="fofr-model" class="section level2">
<h2>FoFR model</h2>
<p>The functional outcome and functional covariate can (but don’t
necessarily need to be) on the same domain. Allows the functional
response <span class="math inline">\(Y(t)\)</span> to depend on the
entire functional predictor(s).</p>
<p><span class="math display">\[Y_i(t) =  \beta_0(t) + \sum_{j}\int_s
\beta_j(t, s)X_{ij}(s)ds  + b_i(t) +  \epsilon_i(t)\]</span></p>
<div id="code-2" class="section level3">
<h3>Code</h3>
<p>This is very similar to the functional historical model, and I will
use the same version of the data. For modeling, I’m also adding a scalar
covariate (use) which could be added to the historical model as well.
I’m also removing the functional random intercept so that it runs a bit
faster, but would recommend keeping this in for modelling when you also
want inference.</p>
<pre class="r"><code>
fofr_mod = pffr(y ~ ff(x, xind = s) + age, 
                     yind = t, fofr_df)
## Warning in ff(x, xind = s): Very low effective rank of &lt;x&gt; detected. 3 largest
## eigenvalues of its covariance alone account for &gt;99.5% of variability. &lt;ffpc&gt;
## might be a better choice here.
## Warning in ff(x, xind = s): &lt;k&gt; larger than effective rank of &lt;x&gt;. Model
## identifiable only through penalty.</code></pre>
<p>Model summary</p>
<pre class="r"><code>summary(fofr_mod)
## 
## Family: gaussian 
## Link function: identity 
## 
## Formula:
## y ~ ff(x, xind = s) + age
## 
## Constant coefficients:
##             Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  -7.4258     0.4346  -17.09   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Smooth terms &amp; functional coefficients:
##                 edf Ref.df      F  p-value    
## Intercept(t) 17.553 19.000 634.54  &lt; 2e-16 ***
## ff(x,s)      21.796 23.033 294.22  &lt; 2e-16 ***
## age(t)        2.559  2.911  12.08 5.36e-07 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## R-sq.(adj) =  0.838   Deviance explained = 83.8%
## -REML score =  49866  Scale est. = 29.701    n = 15972 (121 x 132)</code></pre>
<p>Plotting</p>
<pre class="r"><code>fofr_surf = coef(fofr_mod, n1 = 100, n2 = 100)$smterms$&quot;ff(x,s)&quot;$coef %&gt;%
  select(s = x.smat, t = x.tmat, value = value) %&gt;% 
  as_tibble() 
## using seWithMean for  s(t.vec) .

fofr_surf %&gt;%
  ggplot(aes(s, t)) + 
  geom_tile(aes(fill = value, col = value)) + 
  scale_fill_viridis_c() +
  scale_colour_viridis_c() +
  theme(legend.position = &quot;bottom&quot;)</code></pre>
<p><img src="fda_files/figure-html/unnamed-chunk-27-1.png" width="90%" /></p>
</div>
</div>
</div>
<div id="resources" class="section level1">
<h1>Resources</h1>
<ul>
<li>I highly recommend this <a
href="https://www.amazon.com/Functional-Analysis-Monographs-Statistics-Probability/dp/1032244712/ref=sr_1_6?crid=UEKJYVS8EV6R&amp;keywords=crainiceanu&amp;qid=1698108861&amp;sprefix=crainiceanu%2Caps%2C83&amp;sr=8-6">FDA
with R book</a></li>
</ul>
<p>Some papers about models covered in this tutorial: - <a
href="https://karger.com/dib/article/8/1/83/906653">Functional data
analysis with pupillometer data</a> - <a
href="https://pmc.ncbi.nlm.nih.gov/articles/PMC3285536/">SoFR</a> - <a
href="https://pmc.ncbi.nlm.nih.gov/articles/PMC5457356/">Functional
linear concurrent model</a> - <a
href="https://pmc.ncbi.nlm.nih.gov/articles/PMC4560367/pdf/nihms-589200.pdf">FoFR</a></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
